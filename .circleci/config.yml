version: 2.1

orbs:
  python: circleci/python@3.1.0

# --- Commandes réutilisables ---
commands:
  setup:
    steps:
      - checkout
      - python/install-packages:
          args: "--verbose"
          include-python-in-cache-key: true
          venv-path: '["/home/circleci/venv"]'

  # Liste uniquement les NOMS des variables (jamais les valeurs),
  # puis échoue si un pattern sensible est détecté.
  detect-secrets-names-only:
    steps:
      - run:
          name: "Audit variables (noms uniquement)"
          command: |
            printenv | sort > env_names.txt
            echo "---- ENV VAR NAMES (REDACTED) ----"
            cat env_names.txt
            echo "----------------------------------"

  tests:
    steps:
      - run: python -V
      - run: pip install -e .[dev]
      - run: pytest -q

# --- Jobs ---
jobs:
  pr-test:
    docker:
      - image: cimg/python:3.12
    steps:
      - setup
      - detect-secrets-names-only    # <- détecte et bloque si secrets présents
      - tests

  release-build:
    docker:
      - image: cimg/python:3.12
    steps:
      - setup
      - run: echo "Build/Release ici (contexte OIDC autorisé)"

# --- Workflows ---
workflows:
  pr_checks:
    # Workflow PR: ne reçoit AUCUN contexte sensible
    jobs:
      - pr-test:
          filters:
            branches:
              ignore:
                - main
                - release/*
  
  release_pipeline:
    # Workflow de confiance: seulement sur branches protégées,
    # et c'est ici qu'on attache un contexte contenant OIDC si nécessaire.
    jobs:
      - release-build:
          context: [cloud-oidc]   # <-- OIDC uniquement ici
          filters:
            branches:
              only:
                - main
                - release/*
